{
  "steps": [
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "node_pull",
      "args": ["pull", "gcr.io/$PROJECT_ID/node:latest"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "php_pull",
      "args": ["pull", "gcr.io/$PROJECT_ID/php:latest"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "nginx_pull",
      "args": ["pull", "gcr.io/$PROJECT_ID/nginx:latest"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "varnish_pull",
      "args": ["pull", "gcr.io/$PROJECT_ID/varnish:latest"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "node",
      "args": ["build", "--build-arg", "WORKFOLDER=${_APP_FOLDER_}", "-t", "gcr.io/$PROJECT_ID/node:$COMMIT_SHA", "--target", "${_ENV_PRODUCTION_STAGE_}", "--cache-from", "gcr.io/$PROJECT_ID/node:latest", "-f", "Dockerfile.node", "."]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "node_push",
      "args": ["push", "gcr.io/$PROJECT_ID/node:$COMMIT_SHA"],
      "waitFor": ["node"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "php",
      "args": ["build", "--build-arg", "WORKFOLDER=${_APP_FOLDER_}", "-t", "gcr.io/$PROJECT_ID/php:$COMMIT_SHA", "--target", "${_ENV_PRODUCTION_STAGE_}", "--cache-from", "gcr.io/$PROJECT_ID/php:latest", "."],
      "waitFor": ["node"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "php_push",
      "args": ["push", "gcr.io/$PROJECT_ID/php:$COMMIT_SHA"],
      "waitFor": ["php"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "nginx",
      "args": ["build", "--build-arg", "WORKFOLDER=${_APP_FOLDER_}", "--target", "${_ENV_PRODUCTION_STAGE_}", "-t", "gcr.io/$PROJECT_ID/nginx:$COMMIT_SHA", "--cache-from", "gcr.io/$PROJECT_ID/nginx:latest", "./docker/nginx"
      ],
      "waitFor": ["php_push"],
      "timeout": "10s"
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "nginx_push",
      "args": ["push", "gcr.io/$PROJECT_ID/nginx:$COMMIT_SHA"],
      "waitFor": ["nginx"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "varnish",
      "args": ["build", "--target", "${_ENV_PRODUCTION_STAGE_}", "-t", "gcr.io/$PROJECT_ID/varnish:$COMMIT_SHA", "--cache-from", "gcr.io/$PROJECT_ID/varnish:latest", "./docker/varnish"
      ],
      "waitFor": ["nginx_push"],
      "timeout": "100s"
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "varnish_push",
      "args": ["push", "gcr.io/$PROJECT_ID/varnish:$COMMIT_SHA"],
      "waitFor": ["varnish"]
    }
  ],
  "substitutions": {
    "_APP_FOLDER_": "/var/www/marketReminder",
    "_ENV_PRODUCTION_STAGE_": "production"
  }
}
